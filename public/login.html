<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Conductor • Login</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --bg:#f7f7f9; --card:#fff; --text:#111; --muted:#666; --border:#e6e6ee; --shadow:0 6px 24px rgba(0,0,0,.06); --primary:#3a6df0; }
    @media (prefers-color-scheme: dark){
      :root { --bg:#0f1115; --card:#161a22; --text:#f5f7fb; --muted:#aab3c5; --border:#202533; --shadow:0 6px 24px rgba(0,0,0,.35); }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;line-height:1.4}
    .wrap{max-width:520px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:20px}
    .title{margin:0 0 10px;font-weight:900}
    .muted{color:var(--muted);font-size:.95rem}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);font-size:1rem}
    button{width:100%;margin-top:16px;border:0;border-radius:12px;padding:12px 14px;font-weight:800;background:var(--primary);color:#fff;cursor:pointer}
    .err{color:#c03;font-weight:700;margin:10px 0}
    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .link{color:var(--primary);text-decoration:none;font-weight:700}
    .hintlist{margin:8px 0 0;padding-left:18px}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="form" aria-labelledby="login-title">
      <h1 id="login-title" class="title">Login</h1>
      <p class="muted">Demo auth: <b>username === password</b>. Use either display name or email.</p>
      <ul class="muted hintlist">
        <li>Professor: <code>Prof. Marya Conductor</code></li>
        <li>TA: <code>TA One</code>, <code>TA Two</code>, <code>TA Three</code></li>
        <li>Team leader: any leader name from your DB seed</li>
        <li>Student: any student name you seeded</li>
      </ul>

      <div id="err" class="err" role="alert" aria-live="polite"></div>

      <form id="f" novalidate>
        <label for="u">Username</label>
        <input id="u" name="username" autocomplete="username" placeholder="e.g. TA One or ta.one@example.edu" required>

        <label for="p">Password</label>
        <input id="p" name="password" type="password" autocomplete="current-password" placeholder="same as username (demo)" required>

        <button id="submit" type="submit" aria-label="Sign in">Sign in</button>
      </form>

      <div class="actions">
        <a class="link" href="/">← Back to Home</a>
      </div>
    </div>
  </div>

  <script>
    async function fetchJSON(url, opts){
      const init = opts || {};
      init.headers = Object.assign({ 'Accept':'application/json','Content-Type':'application/json' }, init.headers||{});
      const r = await fetch(url, init);
      let body={}; try{ body = await r.json(); }catch{}
      if(!r.ok) throw new Error(body.error || (r.status + ' ' + r.statusText));
      return body;
    }

    function goByRole(flags){
      if (flags.is_professor)   { location.href = '/professor';    return; }
      if (flags.is_ta)          { location.href = '/ta';           return; }
      if (flags.is_team_leader) { location.href = '/team-leader';  return; }
      location.href = '/student';
    }

    // If already logged in, redirect immediately by role
    (async () => {
      try {
        const me = await fetchJSON('/api/session/me');
        goByRole(me);
      } catch { /* not logged in; stay here */ }
    })();

    document.getElementById('f').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const err = document.getElementById('err'); err.textContent='';
      const u = document.getElementById('u').value.trim();
      const p = document.getElementById('p').value.trim();
      if(!u || !p){ err.textContent='Username and password required.'; return; }

      try{
        const res = await fetchJSON('/api/login', { method:'POST', body: JSON.stringify({ username: u, password: p }) });
        goByRole(res);
      }catch(e){
        err.textContent = e.message || 'Login failed.';
      }
    });

    // Press Enter in password submits
    document.getElementById('p').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ document.getElementById('submit').click(); }
    });
  </script>
</body>
</html>
