<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conductor • Team Leader</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --bg:#f7f7f9; --card:#fff; --text:#111; --muted:#666; --border:#e6e6ee; --shadow:0 6px 24px rgba(0,0,0,.06); --primary:#3a6df0; }
    @media (prefers-color-scheme: dark){
      :root { --bg:#0f1115; --card:#161a22; --text:#f5f7fb; --muted:#aab3c5; --border:#202533; --shadow:0 6px 24px rgba(0,0,0,.35); }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:860px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .brand{font-weight:900}
    .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:800;background:var(--primary);color:#fff;cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    .section-title{margin:0 0 12px;font-weight:900}
    .list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .item{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:12px}
    .muted{color:var(--muted)}
    .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    .leader{border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Conductor • Team Leader</div>
      <div><button id="logout" class="btn">Logout</button></div>
    </header>

    <section class="card">
      <h2 class="section-title">My Team</h2>
      <div id="err" class="muted" role="alert" aria-live="polite"></div>
      <div id="meta" class="muted" style="margin-bottom:10px;"></div>
      <h3 style="margin:0 0 8px;">Assigned TA</h3>
      <div id="ta" class="item" aria-live="polite">Loading…</div>

      <h3 style="margin:14px 0 8px;">Members</h3>
      <ul id="members" class="list" aria-live="polite" aria-busy="true">
        <li class="item" style="opacity:.5;">Loading…</li>
      </ul>
    </section>
  </div>

  <script>
    async function fetchJSON(url, opts){
      const init = opts || {};
      init.headers = Object.assign({ 'Accept':'application/json' }, init.headers || {});
      const r = await fetch(url, init);
      let body = {}; try{ body = await r.json(); }catch{}
      if(!r.ok){
        const msg = body.error || (r.status + ' ' + r.statusText);
        if (r.status === 401) { location.href = '/login.html'; return; }
        throw new Error(msg);
      }
      return body;
    }

    function render(data){
      const meta = document.getElementById('meta');
      const t = data.team;
      meta.textContent = t ? `${t.name} • ${t.course_code} — ${t.course_title} (${t.term_code})` : 'No team found';

      const ta = document.getElementById('ta');
      if (data.ta) {
        ta.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;">
            <img class="avatar" src="${data.ta.ta_photo || 'https://via.placeholder.com/48?text=TA'}" alt="">
            <div><div style="font-weight:800;">${data.ta.ta_name}</div></div>
          </div>
        `;
      } else {
        ta.textContent = 'TA not assigned.';
      }

      const ul = document.getElementById('members');
      ul.setAttribute('aria-busy','false');
      ul.innerHTML = data.members.map(m => `
        <li class="item" style="display:flex;gap:12px;align-items:center;">
          <img class="avatar" src="${m.photo_url || 'https://via.placeholder.com/48?text=S'}" alt="">
          <div>
            <div style="font-weight:800;">${m.display_name}</div>
            <div class="muted" style="font-size:.92rem;">${m.pronouns || ''}</div>
            ${m.is_leader ? '<div class="leader" style="margin-top:6px;">Leader</div>' : ''}
          </div>
        </li>
      `).join('');
    }

    async function init(){
      try {
        const data = await fetchJSON('/api/team-leader/overview');
        render(data);
      } catch(e) {
        document.getElementById('err').textContent = e.message || 'Failed to load.';
      }
    }

    document.getElementById('logout').addEventListener('click', async ()=>{
      try{ await fetch('/api/logout',{method:'POST'}); }catch{}
      location.href = '/login.html';
    });

    init();
  </script>
</body>
</html>
